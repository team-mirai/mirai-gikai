# Admin èªè¨¼æ©Ÿèƒ½ - è¦ä»¶å®šç¾©ã¨å®Ÿè£…è¨ˆç”»

## ğŸ“‹ è¦ä»¶å®šç¾©

### 1. åŸºæœ¬è¦ä»¶

#### ç›®çš„

ç®¡ç†è€…ã®ã¿ãŒ admin ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹

#### å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼

- ç®¡ç†è€…ï¼ˆæ”¿å…šãƒ¡ãƒ³ãƒãƒ¼ï¼‰
<!-- - ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€… -->

### 2. æ©Ÿèƒ½è¦ä»¶

#### èªè¨¼æ©Ÿèƒ½

- âœ… Supabase Auth ã‚’ä½¿ç”¨ã—ãŸãƒ­ã‚°ã‚¤ãƒ³
- âœ… `app_metadata.roles` ã«ã‚ˆã‚‹æ¨©é™ç®¡ç†
- âœ… ç®¡ç†è€…æ¨©é™ã®ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦
- âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½

#### æ¨©é™ç®¡ç†

- `admin` - å…¨æ©Ÿèƒ½ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- `editor` - ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç·¨é›†ã®ã¿ï¼ˆå°†æ¥çš„ã«ï¼‰

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

- âœ… æ¨©é™ãƒã‚§ãƒƒã‚¯ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®Ÿè¡Œ
- âœ… ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®é©åˆ‡ãªãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ã®ç®¡ç†

### 3. éæ©Ÿèƒ½è¦ä»¶

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- èªè¨¼ãƒã‚§ãƒƒã‚¯ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: 200ms ä»¥å†…
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªã®é »åº¦: ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚

#### ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£

- ç›´æ„Ÿçš„ãªãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
- æ¨©é™ã‚¨ãƒ©ãƒ¼æ™‚ã®åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

## ğŸ—ï¸ å®Ÿè£…è¨ˆç”»

### Phase 1: Supabase è¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æº–å‚™

#### ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ

Supabase Studio ã§æ‰‹å‹•ã§ä½œæˆ

<!-- ```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«adminæ¨©é™ã‚’ä»˜ä¸ã™ã‚‹SQLä¾‹
UPDATE auth.users
SET raw_app_meta_data = raw_app_meta_data || '{"roles": ["admin"]}'::jsonb
WHERE email = 'admin@example.com';
``` -->

#### RLS ãƒãƒªã‚·ãƒ¼è¨­å®š

ç‰¹ã«å¯¾å¿œä¸è¦

<!-- ```sql
-- ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªãƒ†ãƒ¼ãƒ–ãƒ«ç”¨RLS
CREATE POLICY "Admin users only" ON public.admin_settings
FOR ALL USING (
  auth.jwt() ->> 'app_metadata'::text::jsonb -> 'roles' ? 'admin'
);
``` -->

### Phase 2: èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…

#### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
admin/src/
â”œâ”€â”€ middleware.ts                    # èªè¨¼ãƒã‚§ãƒƒã‚¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â””â”€â”€ auth.ts                 # èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
â”‚   â””â”€â”€ auth/
â”‚       â””â”€â”€ permissions.ts          # æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°
```

### Phase 3: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢å®Ÿè£…

#### ãƒšãƒ¼ã‚¸æ§‹æˆ

```
admin/src/app/
â”œâ”€â”€ login/
â”‚   â””â”€â”€ page.tsx                    # ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
â”œâ”€â”€ layout.tsx                      # èªè¨¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â””â”€â”€ (protected)/                    # ä¿è­·ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆ
    â”œâ”€â”€ layout.tsx                  # adminç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    â””â”€â”€ dashboard/
        â””â”€â”€ page.tsx                # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
```

### Phase 4: æ¨©é™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½

- Server Actions ã§ã®æ¨©é™ç¢ºèª
- RLS (Row Level Security) ãƒãƒªã‚·ãƒ¼è¨­å®š
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰æ¨©é™ãƒã‚§ãƒƒã‚¯

## ğŸ“ å®Ÿè£…è©³ç´°

### 1. Supabase Auth è¨­å®š

#### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–

packages/supabase ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ

#### æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°

```typescript
// admin/src/lib/auth/permissions.ts
// @supabase/auth-helpers-nextjsã¯éæ¨å¥¨ã§ã™ï¼
// import type { User } from "@supabase/auth-helpers-nextjs";

export async function checkAdminPermission(user: User): Promise<boolean> {
  const roles = user.app_metadata?.roles || [];
  return roles.includes("admin");
}

// export async function checkEditorPermission(user: User): Promise<boolean> {
//   const roles = user.app_metadata?.roles || [];
//   return roles.includes("admin") || roles.includes("editor");
// }
```

### 2. ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…

```typescript
// admin/src/middleware.ts
// @supabase/auth-helpers-nextjsã¯éæ¨å¥¨ã§ã™ï¼
// import { createMiddlewareClient } from "@supabase/auth-helpers-nextjs";
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });

  const {
    data: { session },
  } = await supabase.auth.getSession();

  // èªè¨¼ãƒã‚§ãƒƒã‚¯
  if (!session) {
    return NextResponse.redirect(new URL("/login", req.url));
  }

  // adminæ¨©é™ãƒã‚§ãƒƒã‚¯
  const roles = session.user.app_metadata?.roles || [];
  if (!roles.includes("admin")) {
    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é£›ã°ã™ã§ã‚ˆã•ãã†
    return NextResponse.redirect(new URL("/unauthorized", req.url));
  }

  return res;
}

export const config = {
  matcher: ["/dashboard/:path*", "/api/admin/:path*"],
};
```

### 3. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢å®Ÿè£…

shadcn ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ã†ã“ã¨ï¼

```typescript
// admin/src/app/login/page.tsx
"use client";

import type {FormEvent} from "react";
import { useState } from "react";
import { useRouter } from "next/navigation";
import { supabase } from "@/lib/supabase/client";

export default function LoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const handleLogin = async (e: FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (error) {
      setError("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ");
      setLoading(false);
      return;
    }

    // adminæ¨©é™ãƒã‚§ãƒƒã‚¯
    const roles = data.user?.app_metadata?.roles || [];
    if (roles.includes("admin")) {
      router.push("/dashboard");
    } else {
      setError("ç®¡ç†è€…æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
      await supabase.auth.signOut();
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="max-w-md w-full space-y-8">
        <div>
          <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
            ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
          </h2>
        </div>
        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
          <div className="rounded-md shadow-sm -space-y-px">
            <div>
              <label htmlFor="email" className="sr-only">
                ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
              </label>
              <input
                id="email"
                name="email"
                type="email"
                autoComplete="email"
                required
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
              />
            </div>
            <div>
              <label htmlFor="password" className="sr-only">
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
              </label>
              <input
                id="password"
                name="password"
                type="password"
                autoComplete="current-password"
                required
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm"
                placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
              />
            </div>
          </div>

          {error && (
            <div className="rounded-md bg-red-50 p-4">
              <div className="text-sm text-red-800">{error}</div>
            </div>
          )}

          <div>
            <button
              type="submit"
              disabled={loading}
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50"
            >
              {loading ? "ãƒ­ã‚°ã‚¤ãƒ³ä¸­..." : "ãƒ­ã‚°ã‚¤ãƒ³"}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
```

### 4. ä¿è­·ã•ã‚ŒãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```typescript
// admin/src/app/(protected)/layout.tsx
import type { ReactNode } from "react";
import { redirect } from "next/navigation";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import { cookies } from "next/headers";

export default async function ProtectedLayout({
  children,
}: {
  children: ReactNode;
}) {
  const supabase = createServerComponentClient({ cookies });
  const {
    data: { session },
  } = await supabase.auth.getSession();

  // èªè¨¼å‡¦ç†ã£ã¦ã€middlewareã§ã‚„ã‚‹ã®ã§ã“ã“ã§ã¯å¿…è¦ãªã„ã®ã§ã¯ï¼Ÿ
  if (!session) {
    redirect("/login");
  }

  // èªè¨¼å‡¦ç†ã£ã¦ã€middlewareã§ã‚„ã‚‹ã®ã§ã“ã“ã§ã¯å¿…è¦ãªã„ã®ã§ã¯ï¼Ÿ
  const roles = session.user.app_metadata?.roles || [];
  if (!roles.includes("admin")) {
    redirect("/unauthorized");
  }

  return (
    <div className="min-h-screen bg-gray-100">
      <nav className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16">
            <div className="flex items-center">
              <h1 className="text-xl font-semibold">Admin Dashboard</h1>
            </div>
            <div className="flex items-center">
              <span className="text-sm text-gray-700 mr-4">
                {session.user.email}
              </span>
              <button
                onClick={async () => {
                  await supabase.auth.signOut();
                  redirect("/login");
                }}
                className="text-sm text-red-600 hover:text-red-500"
              >
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
              </button>
            </div>
          </div>
        </div>
      </nav>
      <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">{children}</main>
    </div>
  );
}
```

## ğŸ“Š ã‚¿ã‚¹ã‚¯å„ªå…ˆé †ä½

### é«˜å„ªå…ˆåº¦ (Week 1)

1. âœ… Supabase Auth åŸºæœ¬è¨­å®š
2. âœ… ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã¨ roles è¨­å®š
3. âœ… ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…
4. âœ… ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ä½œæˆ

### ä¸­å„ªå…ˆåº¦ (Week 2)

1. â³ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”»é¢
2. â³ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
3. â³ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„

### ä½å„ªå…ˆåº¦ (Week 3)

1. â³ è¤‡æ•°æ¨©é™ãƒ¬ãƒ™ãƒ«å¯¾å¿œ
2. â³ ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´
3. â³ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»æ©Ÿèƒ½

## ğŸ§ª ãƒ†ã‚¹ãƒˆè¨ˆç”»

### å˜ä½“ãƒ†ã‚¹ãƒˆ

- æ¨©é™ãƒã‚§ãƒƒã‚¯é–¢æ•°
- èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°

### çµåˆãƒ†ã‚¹ãƒˆ

- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼
- æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

### E2E ãƒ†ã‚¹ãƒˆ

- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã‚±ãƒ¼ã‚¹
- æ¨©é™ãªã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦
- ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œæ™‚ã®å‹•ä½œ

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### èªè¨¼é–¢é€£

- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æœ€å°é•·è¦ä»¶ï¼ˆ8 æ–‡å­—ä»¥ä¸Šï¼‰
- ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒå¯¾ç­–ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼‰
- ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ï¼ˆ24 æ™‚é–“ï¼‰

### ãƒ‡ãƒ¼ã‚¿ä¿è­·

- HTTPS ã«ã‚ˆã‚‹é€šä¿¡ã®æš—å·åŒ–
- CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚‹ä¿è­·
- XSS å¯¾ç­–ï¼ˆå…¥åŠ›å€¤ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

### ç›£æŸ»

- ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œã®è¨˜éŒ²
- ç®¡ç†è€…æ“ä½œã®ãƒ­ã‚°è¨˜éŒ²
- å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼

## ğŸ“š å‚è€ƒè³‡æ–™

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Next.js Authentication Best Practices](https://nextjs.org/docs/authentication)
- [Row Level Security (RLS) Guide](https://supabase.com/docs/guides/auth/row-level-security)
