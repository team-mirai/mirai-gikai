# è­°æ¡ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„é›£æ˜“åº¦åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ å®Ÿè£…è¨ˆç”»æ›¸

## 1. å®Ÿè£…æ¦‚è¦

### 1.1 å®Ÿè£…ç¯„å›²

è­°æ¡ˆè©³ç´°ãƒšãƒ¼ã‚¸ã«ãŠã‘ã‚‹ 3 æ®µéšï¼ˆã‚„ã•ã—ã„ãƒ»ãµã¤ã†ãƒ»é›£ã—ã„ï¼‰ã®é›£æ˜“åº¦åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚

### 1.2 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: Next.js (App Router), React, TypeScript
- **çŠ¶æ…‹ç®¡ç†**: React Context API + Cookies
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Supabase (PostgreSQL)
- **ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°**: Tailwind CSS
<!-- - **ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³**: Framer Motion -->

## 2. å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### ãƒ•ã‚§ãƒ¼ã‚º 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»å®Ÿè£…ï¼ˆ2 æ—¥ï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API å®Ÿè£…ï¼ˆ2 æ—¥ï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆ3 æ—¥ï¼‰

### ãƒ•ã‚§ãƒ¼ã‚º 4: ãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´ï¼ˆ1 æ—¥ï¼‰

**åˆè¨ˆå·¥æ•°**: 8 æ—¥

## 3. è©³ç´°å®Ÿè£…è¨ˆç”»

### 3.1 ãƒ•ã‚§ãƒ¼ã‚º 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»å®Ÿè£…

#### 3.1.1 ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

```sql
-- è­°æ¡ˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TYPE difficulty_level_enum AS ENUM ('easy', 'normal', 'hard');

CREATE TABLE bill_contents (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  bill_id UUID NOT NULL REFERENCES bills(id) ON DELETE CASCADE,
  difficulty_level difficulty_level_enum NOT NULL,
  title TEXT NOT NULL,
  summary TEXT NOT NULL,
  content TEXT NOT NULL, -- Markdownå½¢å¼
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  UNIQUE(bill_id, difficulty_level)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_bill_contents_bill_id ON bill_contents(bill_id);
CREATE INDEX idx_bill_contents_difficulty ON bill_contents(difficulty_level);

-- updated_atãƒˆãƒªã‚¬ãƒ¼
CREATE TRIGGER update_bill_contents_updated_at BEFORE UPDATE ON bill_contents
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Row Level Security
ALTER TABLE bill_contents ENABLE ROW LEVEL SECURITY;

-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆ
COMMENT ON TABLE bill_contents IS 'è­°æ¡ˆã®é›£æ˜“åº¦åˆ¥ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«';
COMMENT ON COLUMN bill_contents.difficulty_level IS 'é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«ï¼ˆeasy:ã‚„ã•ã—ã„, normal:ãµã¤ã†, hard:é›£ã—ã„ï¼‰';
COMMENT ON COLUMN bill_contents.content IS 'Markdownå½¢å¼ã®è­°æ¡ˆå†…å®¹';
```

#### 3.1.2 æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã¨åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥

- æ—¢å­˜ã®è­°æ¡ˆãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤
- packages/seed ã‚’ç·¨é›†
- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ 3 æ®µéšåˆ†ä½œæˆã—ã¦æŠ•å…¥

### 3.2 ãƒ•ã‚§ãƒ¼ã‚º 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### 3.2.1 Supabase Types æ›´æ–°

```bash
pnpm supabase:types:gen
```

#### 3.2.2 ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ã®å®Ÿè£…ï¼ˆRSC ç”¨ï¼‰

ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¯æ—¢å­˜ã®ã‚‚ã®ã‚’å‚è€ƒã«ã™ã‚‹ï¼

**`features/bills/api/bills-api.ts`**

```typescript
import { createClient } from "@/lib/supabase/server";

export const billsApi = {
  // è­°æ¡ˆã¨æŒ‡å®šé›£æ˜“åº¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ï¼ˆRSCç”¨ï¼‰
  getBillWithContent: async (billId: string, difficulty: DifficultyLevel) => {
    const supabase = createClient();

    const { data: bill } = await supabase
      .from("bills")
      .select(
        `
        *,
        bill_contents!inner(
          *
        )
      `
      )
      .eq("id", billId)
      .eq("bill_contents.difficulty_level", difficulty)
      .single();

    return bill;
  },

  // ç‰¹å®šé›£æ˜“åº¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã¿å–å¾—
  getBillContent: async (billId: string, difficulty: DifficultyLevel) => {
    const supabase = createClient();

    const { data } = await supabase
      .from("bill_contents")
      .select("*")
      .eq("bill_id", billId)
      .eq("difficulty_level", difficulty)
      .single();

    return data;
  },

  // å…¨é›£æ˜“åº¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ï¼‰
  getAllDifficultyContents: async (billId: string) => {
    const supabase = createClient();

    const { data } = await supabase
      .from("bill_contents")
      .select("*")
      .eq("bill_id", billId);

    // é›£æ˜“åº¦ã‚’ã‚­ãƒ¼ã¨ã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
    return data?.reduce((acc, content) => {
      acc[content.difficulty_level] = content;
      return acc;
    }, {} as Record<DifficultyLevel, BillContent>);
  },
};
```

### 3.3 ãƒ•ã‚§ãƒ¼ã‚º 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### 3.3.1 Cookieãƒ™ãƒ¼ã‚¹ã®é›£æ˜“åº¦ç®¡ç†ï¼ˆContextä¸ä½¿ç”¨ï¼‰

**ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æœ€å¤§é™æ´»ç”¨ã™ã‚‹ãŸã‚ã€Contextã‚’ä½¿ã‚ãšã«Cookieã¨Server Actionsã§å®Ÿè£…ã—ã¾ã™ã€‚**

**`features/bills/actions/difficulty-actions.ts`**

```typescript
'use server';

import type {FC} from "react";
import { cookies } from 'next/headers';
import { revalidatePath } from 'next/cache';

const COOKIE_NAME = 'content_difficulty_level';
const COOKIE_MAX_AGE = 60 * 60 * 24 * 365; // 1å¹´

export async function setDifficultyLevel(level: DifficultyLevel, currentPath: string) {
  cookies().set(COOKIE_NAME, level, {
    maxAge: COOKIE_MAX_AGE,
    path: '/',
    sameSite: 'lax',
    secure: process.env.NODE_ENV === 'production',
  });
  
  // ãƒšãƒ¼ã‚¸ã‚’å†æ¤œè¨¼ã—ã¦æ–°ã—ã„é›£æ˜“åº¦ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  revalidatePath(currentPath);
}

export async function getDifficultyLevel(): Promise<DifficultyLevel> {
  const cookieStore = cookies();
  const difficulty = cookieStore.get(COOKIE_NAME);
  return (difficulty?.value as DifficultyLevel) || 'normal';
}
```

#### 3.3.2 é›£æ˜“åº¦åˆ‡ã‚Šæ›¿ãˆ UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**`features/bills/components/difficulty-selector.tsx`**

```typescript
'use client';

import { usePathname } from 'next/navigation';
import { setDifficultyLevel } from '../actions/difficulty-actions';

interface DifficultySelectorProps {
  currentDifficulty: DifficultyLevel;
}

export const DifficultySelector: FC<DifficultySelectorProps> = ({ 
  currentDifficulty 
}) => {
  const pathname = usePathname();

  const levels = [
    { value: 'easy' as const, label: 'ã‚„ã•ã—ã„', emoji: 'ğŸ‘¶' },
    { value: 'normal' as const, label: 'ãµã¤ã†', emoji: 'ğŸ‘¨' },
    { value: 'hard' as const, label: 'é›£ã—ã„', emoji: 'ğŸ“' },
  ];

  const handleDifficultyChange = async (level: DifficultyLevel) => {
    await setDifficultyLevel(level, pathname);
  };

  return (
    <div className="flex gap-2 p-4 bg-gray-50 rounded-lg">
      {levels.map((level) => (
        <button
          key={level.value}
          onClick={() => handleDifficultyChange(level.value)}
          className={cn(
            "px-4 py-2 rounded-md transition-all flex items-center gap-2",
            currentDifficulty === level.value
              ? "bg-blue-500 text-white"
              : "bg-white text-gray-700 hover:bg-gray-100"
          )}
        >
          <span>{level.emoji}</span>
          <span>{level.label}</span>
        </button>
      ))}
    </div>
  );
};
```

#### 3.3.3 è­°æ¡ˆè©³ç´°ãƒšãƒ¼ã‚¸ã®æ›´æ–°

**`app/bills/[billId]/page.tsx`**

```typescript
import { getDifficultyLevel } from '@/features/bills/actions/difficulty-actions';
import { billsApi } from '@/features/bills/api/bills-api';
import { DifficultySelector } from '@/features/bills/components/difficulty-selector';
import { BillDetailContent } from '@/features/bills/components/bill-detail-content';

export default async function BillDetailPage({
  params,
}: {
  params: { billId: string };
}) {
  // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§Cookieã‹ã‚‰é›£æ˜“åº¦ã‚’å–å¾—
  const difficulty = await getDifficultyLevel();
  
  // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§è­°æ¡ˆã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
  const billWithContent = await billsApi.getBillWithContent(params.billId, difficulty);
  
  if (!billWithContent) {
    return <div>è­°æ¡ˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;
  }
  
  return (
    <div className="container mx-auto px-4 py-8">
      <DifficultySelector currentDifficulty={difficulty} />
      <BillDetailContent 
        bill={billWithContent} 
        content={billWithContent.bill_contents[0]}
      />
    </div>
  );
}
```

**`features/bills/components/bill-detail-content.tsx`**

```typescript
import { marked } from 'marked';

interface BillDetailContentProps {
  bill: Bill;
  content: BillContent;
}

// ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦å®Ÿè£…
export const BillDetailContent: FC<BillDetailContentProps> = async ({ 
  bill, 
  content 
}) => {
  // Markdownã‚’HTMLã«å¤‰æ›
  const contentHtml = await marked(content.content);
  
  return (
    <>
      <h1 className="text-3xl font-bold mt-6 mb-4">
        {content.title}
      </h1>

      <div className="bg-blue-50 p-6 rounded-lg mb-6">
        <h2 className="text-xl font-semibold mb-3">è¦ç´„</h2>
        <p>{content.summary}</p>
      </div>

      <div className="prose max-w-none mb-8">
        <div dangerouslySetInnerHTML={{ __html: contentHtml }} />
      </div>
    </>
  );
};
```

#### 3.3.4 å‹å®šç¾©

**`features/bills/types/difficulty.ts`**

```typescript
export type DifficultyLevel = 'easy' | 'normal' | 'hard';

export interface BillContent {
  id: string;
  bill_id: string;
  difficulty_level: DifficultyLevel;
  title: string;
  summary: string;
  content: string; // Markdownå½¢å¼
  created_at: string;
  updated_at: string;
}
```

### 3.4 ãƒ•ã‚§ãƒ¼ã‚º 4: ãƒ†ã‚¹ãƒˆãƒ»èª¿æ•´

#### 3.4.1 å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè£…

- Server Actions ã®ãƒ†ã‚¹ãƒˆ
- ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ã®ãƒ†ã‚¹ãƒˆ
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ

#### 3.4.2 E2E ãƒ†ã‚¹ãƒˆå®Ÿè£…

- é›£æ˜“åº¦åˆ‡ã‚Šæ›¿ãˆãƒ•ãƒ­ãƒ¼
- Cookie æ°¸ç¶šåŒ–ã®ç¢ºèª
- ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã®è¨­å®šç¶­æŒ

#### 3.4.3 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

- åˆ‡ã‚Šæ›¿ãˆæ™‚ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¸¬å®šãƒ»æ”¹å–„
- ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®ç¢ºèª
- ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®é™¤å»

## 4. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
mirai-gikai/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ bills/
â”‚       â””â”€â”€ [billId]/
â”‚           â””â”€â”€ page.tsx
â”œâ”€â”€ features/
â”‚   â””â”€â”€ bills/
â”‚       â”œâ”€â”€ actions/
â”‚       â”‚   â””â”€â”€ difficulty-actions.ts
â”‚       â”œâ”€â”€ api/
â”‚       â”‚   â””â”€â”€ bills-api.ts
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ bill-detail-content.tsx
â”‚       â”‚   â””â”€â”€ difficulty-selector.tsx
â”‚       â””â”€â”€ types/
â”‚           â””â”€â”€ difficulty.ts
â””â”€â”€ supabase/
    â””â”€â”€ migrations/
        â””â”€â”€ 20250914_add_bill_contents_table.sql
```

## 5. å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹

### 5.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- XSS å¯¾ç­–: `dangerouslySetInnerHTML`ä½¿ç”¨æ™‚ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º
- Cookie ã®ã‚»ã‚­ãƒ¥ã‚¢è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

### 5.2 ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£

- é©åˆ‡ãª ARIA ãƒ©ãƒ™ãƒ«ã®è¨­å®š
- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†

### 5.3 SEO

- å„é›£æ˜“åº¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é©åˆ‡ãªãƒ¡ã‚¿ã‚¿ã‚°è¨­å®š
- æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ 

### 5.4 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å–å¾—å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®å†è©¦è¡Œå‡¦ç†

## 6. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨ˆç”»

### 6.1 ç’°å¢ƒåˆ¥å¯¾å¿œ

- **é–‹ç™ºç’°å¢ƒ**: ãƒ­ãƒ¼ã‚«ãƒ« Supabase ä½¿ç”¨
- **ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ**: ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã§å‹•ä½œç¢ºèª
- **æœ¬ç•ªç’°å¢ƒ**: æ®µéšçš„ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ

### 6.2 ãƒªãƒªãƒ¼ã‚¹æ‰‹é †

1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
2. API ãƒ‡ãƒ—ãƒ­ã‚¤
3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
4. å‹•ä½œç¢ºèª
5. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

## 7. ä»Šå¾Œã®æ”¹å–„æ¡ˆ

### 7.1 çŸ­æœŸçš„æ”¹å–„

- ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
- ãƒ¢ãƒã‚¤ãƒ« UI ã®æœ€é©åŒ–
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®æ”¹å–„

### 7.2 ä¸­é•·æœŸçš„æ”¹å–„

- AI ã«ã‚ˆã‚‹è‡ªå‹•ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç†è§£åº¦ã«å¿œã˜ãŸå‹•çš„é›£æ˜“åº¦èª¿æ•´
- éŸ³å£°èª­ã¿ä¸Šã’æ©Ÿèƒ½ã®è¿½åŠ 
