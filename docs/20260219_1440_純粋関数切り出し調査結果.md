# 純粋関数切り出し・テスト追加候補 調査結果

## 概要

web/src 配下の全モジュールを5チームで並列調査し、コンポーネントやサーバーロジック内に埋め込まれた純粋関数（テスト可能なロジック）の候補を洗い出した。

### 調査範囲

| 担当 | 対象ディレクトリ |
|---|---|
| bills | `features/bills/` |
| session | `features/interview-session/server/` |
| report | `features/interview-report/`, `features/interview-config/` |
| chat | `features/chat/`, `features/bill-difficulty/`, `features/interview-session/client/` |
| lib | `lib/`, `components/`, `hooks/`, `middleware.ts`, `config/` |

---

## Tier 1: 既にexport済みの純粋関数（テスト追加のみ）

テスト追加だけで済む。コード変更不要、効果が高い。

| # | ファイル | 関数 | 内容 |
|---|---|---|---|
| 1 | `features/bills/shared/types/index.ts` | `getBillStatusLabel` | ステータス+発議院 → 日本語ラベル（分岐が多く価値高） |
| 2 | `features/bills/client/utils/share.ts` | `createBillShareUrl`, `createShareMessage` | シェアURL・メッセージ生成 |
| 3 | `features/interview-report/shared/constants.ts` | `formatRoleLabel` | ロール+タイトル → 表示ラベル |
| 4 | `features/interview-session/server/utils/interview-logic.ts` | `collectAskedQuestionIds` | メッセージ配列 → 質問ID Set |
| 5 | `lib/basic-auth.ts` | `parseBasicAuth` | Base64認証ヘッダーのパース（セキュリティ関連） |
| 6 | `lib/social-links.ts` | `getSocialLinksArray` | ソーシャルリンク定数の配列変換 |

## Tier 2: 切り出し+テスト追加（小規模リファクタ）

関数の引数を変更して依存を除去し、純粋関数化する。

| # | ファイル:行 | 現在のロジック | 切り出し先（案） |
|---|---|---|---|
| 7 | `bills/client/components/bill-status-badge.tsx:10` | `getCardStatusLabel(status)` - カード用ステータスラベル | `shared/utils/bill-status.ts` |
| 8 | `bills/client/components/bill-status-badge.tsx:26` | `getStatusVariant(status)` - Badgeのvariant決定 | 同上 |
| 9 | `bills/client/components/bill-status-progress.tsx` | ステップ順序調整・進捗幅計算・ステップ状態判定 | `shared/utils/bill-progress.ts` |
| 10 | `bills/client/components/mirai-stance-card.tsx:19` | `getStanceStyles()` - スタンスに応じたスタイル決定 | `shared/utils/stance-styles.ts` |
| 11 | `bills/server/loaders/helpers/get-bill-tags.ts:13` | `groupTagsByBillId()` - タグの bill_id グループ化 | export化してテスト追加 |
| 12 | `lib/basic-auth.ts:33` | `isPageSpeedInsights(request)` → UA文字列を受ける形に | `isPageSpeedInsightsUA(ua: string)` |
| 13 | `lib/basic-auth.ts:44` | `validateBasicAuth(request, config)` → ヘッダー文字列を受ける形に | `validateBasicAuthHeader(header, config)` |
| 14 | `middleware.ts:44` | `_isValidDifficultyLevel(value)` - 難易度バリデーション型ガード | export化して共用 |
| 15 | `middleware.ts:72` | `_isHtmlRequest(request)` → Accept文字列を受ける形に | `isHtmlAcceptHeader(accept: string)` |
| 16 | `lib/utils/url.ts:3` | `getOrigin()` → ヘッダー値を受ける形に | `buildOriginUrl(host, proto)` |
| 17 | `components/ai-elements/inline-citation.tsx:71` | ソースURL表示ロジック | `formatCitationLabel(sources: string[])` |
| 18 | `interview-report/shared/components/interviewee-info.tsx:23` | roleDescription改行整形（・プレフィックス付与） | `formatRoleDescriptionLines(text)` |
| 19 | `interview-report/server/components/report-complete-page.tsx:50` | opinions JSONパース（2箇所で重複） | `parseOpinions(opinions: unknown)` |

## Tier 3: interview-session/server のロジック（`"server-only"` モック必要）

テスト時に `vi.mock("server-only", () => ({}))` が必要だが、ロジック自体は純粋。

| # | ファイル | 関数 | 内容 |
|---|---|---|---|
| 20 | `server/services/complete-interview-session.ts:17` | `extractReportFromMessage` | メッセージからレポートJSON抽出+Zodバリデーション |
| 21 | `server/utils/interview-logic/bulk-mode.ts` | `bulkModeLogic.calculateNextQuestionId` | 未回答の次の質問IDを返す |
| 22 | `server/utils/interview-logic/bulk-mode.ts` | `bulkModeLogic.checkProgress` | 深掘り質問数で進捗判定（境界値テスト向き） |
| 23 | `server/utils/interview-logic/bulk-mode.ts` | `bulkModeLogic.buildSystemPrompt` | Bulk Mode用プロンプト構築 |
| 24 | `server/utils/interview-logic/bulk-mode.ts` | `bulkModeLogic.buildFacilitatorPrompt` | ファシリテータープロンプト構築 |
| 25 | `server/utils/interview-logic/loop-mode.ts` | `loopModeLogic.buildSystemPrompt` | Loop Mode用プロンプト構築 |
| 26 | `server/utils/interview-logic/loop-mode.ts` | `loopModeLogic.buildFacilitatorPrompt` | ファシリテータープロンプト構築 |
| 27 | `server/utils/build-interview-system-prompt.ts` | `buildSummarySystemPrompt` | 要約用プロンプト構築 |
| 28 | `server/utils/build-interview-system-prompt.ts` | `buildInterviewSystemPrompt` | モードルーティング |

## Tier 4: chat/server のロジック（小さな純粋関数群）

handle-chat-request.ts 内のprivate関数群。export化+テスト追加。

| # | ファイル:行 | 関数 | 内容 |
|---|---|---|---|
| 29 | `chat/server/services/handle-chat-request.ts:116` | `extractChatContext` | メッセージからコンテキスト抽出+デフォルト値 |
| 30 | `chat/server/services/handle-chat-request.ts:148` | prompt名+変数決定ロジック | pageTypeに応じたプロンプト名・変数マッピング |
| 31 | `chat/server/services/handle-chat-request.ts:185` | `getJstDayRange` | JST基準の1日の時間範囲計算 |
| 32 | `chat/server/services/handle-chat-request.ts:229` | `buildUsageMetadata` | 使用状況メタデータ構築 |
| 33 | `chat/server/services/handle-chat-request.ts:250` | `extractGatewayCost` | providerMetadataからコスト安全抽出 |
| 34 | `chat/server/services/cost-tracker.ts:88` | `parseCost` | cost_usd値の安全な数値変換 |
| 35 | `chat/server/services/cost-tracker.ts:93` | `resolveCostUsd` | コスト解決ロジック（override/token計算/fallback） |

## Tier 5: クライアントフック内のロジック切り出し

| # | ファイル | ロジック | 切り出し先 |
|---|---|---|---|
| 36 | `interview-session/client/hooks/use-quick-replies.ts:15` | クイックリプライ表示判定ロジック | `client/utils/get-current-quick-replies.ts` |

---

## 推奨実装順序

### Phase 1: テスト追加のみ（コード変更なし）
- Tier 1 の #1〜#6

### Phase 2: 小規模リファクタ+テスト
- Tier 2 の #7〜#19

### Phase 3: server-only モック設定+テスト
- Tier 3 の #20〜#28

### Phase 4: chat系private関数のexport化+テスト
- Tier 4 の #29〜#35

### Phase 5: クライアントロジック切り出し
- Tier 5 の #36

---

## 対象外と判断したもの

- React Componentの純粋なJSXレンダリング部分
- Supabase/DB呼び出しに依存するloader/action全体
- `process.env` に依存する環境設定（`lib/env.ts`）
- DOM API依存（`lib/rubyful/`, `hooks/use-media-query.ts` 等）
- 定数定義のみのファイル（`cache-tags.ts`, `models.ts`, `external-links.ts` 等）
- 既にテスト済みのファイル（6ファイル）
